<!-- Agrega esta sección después del menú de navegación -->
<section id="bodega" class="section bg-light mt-4">
    <h3>Inventario de Bodega</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Insumo</th>
                <th>Cantidad Disponible</th>
                <th>Última Actualización</th>
            </tr>
        </thead>
        <tbody id="inventarioBodega">
            <!-- Los datos se cargarán dinámicamente -->
        </tbody>
    </table>
</section>

<script>
// Modificamos la base de datos para incluir la bodega
let db = {
    actividades: JSON.parse(localStorage.getItem('actividades')) || [],
    insumos: JSON.parse(localStorage.getItem('insumos')) || [],
    usos: JSON.parse(localStorage.getItem('usos')) || [],
    bodega: JSON.parse(localStorage.getItem('bodega')) || []
};

// Función para actualizar la bodega
function actualizarBodega(nombreInsumo, cantidad, fecha, operacion = 'entrada') {
    const insumoIndex = db.bodega.findIndex(item => item.nombre === nombreInsumo);
    
    if (insumoIndex >= 0) {
        // Actualizar existencia
        if (operacion === 'entrada') {
            db.bodega[insumoIndex].cantidad += cantidad;
        } else {
            db.bodega[insumoIndex].cantidad -= cantidad;
        }
        
        // Actualizar fecha
        db.bodega[insumoIndex].ultimaActualizacion = fecha;
    } else {
        // Registrar nuevo insumo
        db.bodega.push({
            nombre: nombreInsumo,
            cantidad: operacion === 'entrada' ? cantidad : -cantidad,
            ultimaActualizacion: fecha
        });
    }
    
    actualizarUIbodega();
    guardarDB();
}

// Función para actualizar la UI de bodega
function actualizarUIbodega() {
    const tbody = document.getElementById('inventarioBodega');
    tbody.innerHTML = db.bodega.map(insumo => `
        <tr>
            <td>${insumo.nombre}</td>
            <td>${insumo.cantidad}</td>
            <td>${new Date(insumo.ultimaActualizacion).toLocaleDateString()}</td>
        </tr>
    `).join('');
}

// Modificamos el formulario de compras
document.getElementById('formCompra').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const insumo = {
        nombre: this.querySelector('input:nth-child(1)').value,
        cantidad: parseInt(this.querySelector('input:nth-child(2)').value),
        costoUnitario: parseFloat(this.querySelector('input:nth-child(3)').value),
        fecha: this.querySelector('input[type="date"]').value
    };
    
    // Actualizar bodega
    actualizarBodega(insumo.nombre, insumo.cantidad, insumo.fecha, 'entrada');
    
    // Registrar compra
    db.insumos.push(insumo);
    guardarDB();
    this.reset();
});

// Modificamos el formulario de uso de insumos
document.getElementById('formUso').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const insumoNombre = this.querySelector('select').value;
    const cantidad = parseInt(this.querySelector('input:nth-child(2)').value);
    const lote = this.querySelector('input:nth-child(3)').value;
    const fecha = this.querySelector('input[type="date"]').value;
    
    // Verificar existencia en bodega
    const existencia = db.bodega.find(item => item.nombre === insumoNombre)?.cantidad || 0;
    
    if (existencia < cantidad) {
        alert(`¡No hay suficiente stock! Disponible: ${existencia}`);
        return;
    }
    
    // Actualizar bodega
    actualizarBodega(insumoNombre, cantidad, fecha, 'salida');
    
    // Registrar uso
    db.usos.push({
        insumo: insumoNombre,
        cantidad: cantidad,
        lote: lote,
        fecha: fecha
    });
    
    guardarDB();
    this.reset();
});

// Actualizar el selector de insumos dinámicamente
function actualizarSelectInsumos() {
    const select = document.querySelector('#formUso select');
    select.innerHTML = '<option value="">Seleccionar insumo</option>' + 
        db.bodega.map(insumo => `
            <option value="${insumo.nombre}">${insumo.nombre} (${insumo.cantidad} disponibles)</option>
        `).join('');
}

// Modificar la función guardarDB
function guardarDB() {
    localStorage.setItem('actividades', JSON.stringify(db.actividades));
    localStorage.setItem('insumos', JSON.stringify(db.insumos));
    localStorage.setItem('usos', JSON.stringify(db.usos));
    localStorage.setItem('bodega', JSON.stringify(db.bodega));
    actualizarSelectInsumos();
    actualizarUIbodega();
}

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', () => {
    actualizarUIbodega();
    actualizarSelectInsumos();
});
</script>
