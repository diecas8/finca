<!-- Agrega este nuevo formulario después del formulario de insumos -->
<div class="form-container">
    <h2>📦 Uso de Insumos en Lotes</h2>
    <form id="usoInsumosForm">
        <div class="form-group">
            <label>Lote:</label>
            <select id="loteUsoInsumo" required></select>
        </div>
        <div class="form-group">
            <label>Insumo:</label>
            <select id="insumoDisponible" required></select>
        </div>
        <div class="form-group">
            <label>Cantidad a usar:</label>
            <input type="number" step="0.01" id="cantidadUso" required>
        </div>
        <div class="form-group">
            <label>Fecha de uso:</label>
            <input type="date" id="fechaUso" required>
        </div>
        <button type="button" onclick="registrarUsoInsumo()">Registrar Uso</button>
    </form>
</div>

<!-- Agrega esta tabla en la sección de tablas -->
<div class="form-container">
    <h3>📋 Insumos Utilizados por Lote</h3>
    <table>
        <thead>
            <tr>
                <th>Lote</th>
                <th>Insumo</th>
                <th>Cantidad</th>
                <th>Unidad</th>
                <th>Fecha Uso</th>
            </tr>
        </thead>
        <tbody id="registrosUsoInsumos"></tbody>
    </table>
</div>

<script>
    // Modifica la estructura de insumos para incluir cantidad disponible
    let insumos = []; // Ahora con estructura: { ..., cantidad: X, disponible: X }

    // Nueva variable para seguimiento de usos
    let usoInsumos = [];

    // Modifica la función guardarInsumo para incluir disponibilidad
    function guardarInsumo() {
        const insumo = {
            fecha: document.getElementById('fechaCompra').value,
            tipo: document.getElementById('tipoInsumo').value,
            unidad: document.getElementById('unidadMedida').value,
            cantidad: parseFloat(document.getElementById('cantidadInsumo').value),
            disponible: parseFloat(document.getElementById('cantidadInsumo').value), // Nueva propiedad
            valor: parseFloat(document.getElementById('valorUnitario').value),
            total: parseFloat(document.getElementById('totalInsumo').textContent.replace(/,/g, ''))
        };

        if (editandoInsumo) {
            // Mantener el cálculo de disponibilidad al editar
            const original = insumos[indiceEdicionInsumo];
            insumo.disponible = original.disponible + (insumo.cantidad - original.cantidad);
            
            insumos[indiceEdicionInsumo] = insumo;
            editandoInsumo = false;
        } else {
            insumos.push(insumo);
        }

        actualizarSelectInsumos();
        actualizarTablaInsumos();
        document.getElementById('insumosForm').reset();
    }

    // Función para actualizar selects de lotes e insumos
    function actualizarSelectInsumos() {
        const selectLotes = document.getElementById('loteUsoInsumo');
        const selectInsumos = document.getElementById('insumoDisponible');
        
        // Actualizar lotes
        selectLotes.innerHTML = lotes.map(lote => 
            `<option value="${lote.numero}">Lote ${lote.numero}</option>`
        ).join('');
        
        // Actualizar insumos con disponibilidad
        selectInsumos.innerHTML = insumos
            .filter(insumo => insumo.disponible > 0)
            .map((insumo, index) => 
                `<option value="${index}">${insumo.tipo} (${insumo.disponible} ${insumo.unidad})</option>`
            ).join('');
    }

    // Función para registrar el uso de insumos
    function registrarUsoInsumo() {
        const loteNumero = parseInt(document.getElementById('loteUsoInsumo').value);
        const insumoIndex = parseInt(document.getElementById('insumoDisponible').value);
        const cantidad = parseFloat(document.getElementById('cantidadUso').value);
        const fecha = document.getElementById('fechaUso').value;

        const insumo = insumos[insumoIndex];
        
        // Validar disponibilidad
        if (cantidad > insumo.disponible) {
            alert(`No hay suficiente stock! Disponible: ${insumo.disponible} ${insumo.unidad}`);
            return;
        }

        // Actualizar inventario
        insumo.disponible -= cantidad;
        
        // Registrar uso
        const uso = {
            lote: loteNumero,
            insumo: insumo.tipo,
            cantidad: cantidad,
            unidad: insumo.unidad,
            fecha: fecha
        };
        
        usoInsumos.push(uso);
        
        // Actualizar lotes con el insumo usado
        const lote = lotes.find(l => l.numero === loteNumero);
        if (!lote.insumosUsados) lote.insumosUsados = [];
        lote.insumosUsados.push(uso);

        actualizarSelectInsumos();
        actualizarTablaUsoInsumos();
        document.getElementById('usoInsumosForm').reset();
    }

    // Función para actualizar tabla de usos
    function actualizarTablaUsoInsumos() {
        const tbody = document.getElementById('registrosUsoInsumos');
        tbody.innerHTML = usoInsumos.map(uso => `
            <tr>
                <td>${uso.lote}</td>
                <td>${uso.insumo}</td>
                <td>${uso.cantidad}</td>
                <td>${uso.unidad}</td>
                <td>${uso.fecha}</td>
            </tr>
        `).join('');
    }

    // Modificar la tabla de insumos para mostrar disponibilidad
    function actualizarTablaInsumos() {
        const tbody = document.getElementById('registrosInsumos');
        tbody.innerHTML = insumos.map((insumo, index) => `
            <tr>
                <td>${insumo.fecha}</td>
                <td>${insumo.tipo}</td>
                <td>${insumo.unidad}</td>
                <td>${insumo.cantidad}</td>
                <td>${insumo.disponible}</td>
                <td>$${insumo.valor.toLocaleString()}</td>
                <td>$${insumo.total.toLocaleString()}</td>
                <td>
                    <button onclick="editarInsumo(${index})">Editar</button>
                    <button onclick="eliminarInsumo(${index})">Eliminar</button>
                </td>
            </tr>
        `).join('');
    }

    // Actualizar los event listeners para incluir nuevas funciones
    document.addEventListener('DOMContentLoaded', () => {
        actualizarLotesSelector();
        actualizarSelectInsumos();
    });
</script>
