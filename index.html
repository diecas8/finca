<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral Finca Cafetera</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c5f2d;
            --secondary: #97bc62;
            --background: #f0f7da;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            background: var(--background);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .grid-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
            font-weight: 500;
        }

        input, select, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 3px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: var(--secondary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: var(--primary);
            color: white;
        }

        .chart-container {
            margin: 20px 0;
            max-width: 600px;
        }

        @media (max-width: 768px) {
            .grid-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Encabezado -->
        <div class="section">
            <h2>Información General</h2>
            <div class="grid-form">
                <div class="form-group">
                    <label>Nombre Finca</label>
                    <input type="text" id="nombreFinca" required>
                </div>
                <div class="form-group">
                    <label>Área Total (ha)</label>
                    <input type="number" id="areaTotal" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Propietario</label>
                    <input type="text" id="propietario" required>
                </div>
            </div>
        </div>

        <!-- Gestión de Lotes -->
        <div class="section">
            <h2>Gestión de Lotes</h2>
            <form class="grid-form" id="formLote">
                <div class="form-group">
                    <label>Número Lote</label>
                    <input type="text" id="numLote" required>
                </div>
                <div class="form-group">
                    <label>Variedad</label>
                    <input type="text" id="variedad" required>
                </div>
                <div class="form-group">
                    <label>Área (ha)</label>
                    <input type="number" id="areaLote" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Distancia Calles (m)</label>
                    <input type="number" id="distCalles" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>Distancia Plantas (m)</label>
                    <input type="number" id="distPlantas" step="0.1" required>
                </div>
            </form>
            <button onclick="calcularDensidad()">Calcular</button>
            <button onclick="guardarLote()">Guardar Lote</button>
            <div id="resultadosLote">
                <p>Densidad: <span id="densidad">0</span> plantas/ha</p>
                <p>Número Plantas: <span id="numPlantas">0</span></p>
            </div>
            <table id="tablaLotes"></table>
        </div>

        <!-- Bodega y Compras -->
        <div class="section">
            <h2>Bodega de Insumos</h2>
            <div class="grid-form">
                <div class="form-group">
                    <label>Insumo</label>
                    <input type="text" id="insumo" required>
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="cantidad" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>Precio Unitario</label>
                    <input type="number" id="precio" step="0.01" required>
                </div>
            </div>
            <button onclick="agregarInsumo()">Registrar Insumo</button>
            <table id="tablaInsumos"></table>
        </div>

        <!-- Gráficos y Reportes -->
        <div class="section">
            <h2>Análisis y Reportes</h2>
            <select id="selectLote" onchange="actualizarGraficos()"></select>
            <div class="chart-container">
                <canvas id="chartProduccion"></canvas>
            </div>
            <button onclick="generarPDF()">PDF</button>
            <button onclick="generarExcel()">Excel</button>
        </div>
    </div>

<script>
// Sistema de persistencia
const DB = {
    get: key => JSON.parse(localStorage.getItem(key)) || {},
    set: (key, val) => localStorage.setItem(key, JSON.stringify(val))
};

// Estado inicial
let state = {
    lotes: DB.get('lotes') || [],
    insumos: DB.get('insumos') || {},
    actividades: DB.get('actividades') || [],
    cosechas: DB.get('cosechas') || []
};

// Funciones principales
function calcularDensidad() {
    const area = parseFloat(document.getElementById('areaLote').value);
    const calles = parseFloat(document.getElementById('distCalles').value);
    const plantas = parseFloat(document.getElementById('distPlantas').value);
    
    const densidad = 10000 / (calles * plantas);
    document.getElementById('densidad').textContent = densidad.toFixed(2);
    document.getElementById('numPlantas').textContent = Math.round(area * densidad);
}

function guardarLote() {
    const lote = {
        id: document.getElementById('numLote').value,
        variedad: document.getElementById('variedad').value,
        area: parseFloat(document.getElementById('areaLote').value),
        densidad: parseFloat(document.getElementById('densidad').textContent),
        plantas: parseInt(document.getElementById('numPlantas').textContent),
        cosechas: []
    };
    
    state.lotes.push(lote);
    DB.set('lotes', state.lotes);
    actualizarUI();
}

function agregarInsumo() {
    const insumo = document.getElementById('insumo').value;
    state.insumos[insumo] = {
        cantidad: parseFloat(document.getElementById('cantidad').value),
        precio: parseFloat(document.getElementById('precio').value)
    };
    DB.set('insumos', state.insumos);
    actualizarUI();
}

// Generación de reportes
function generarPDF() {
    const doc = new jspdf.jsPDF();
    doc.text('Reporte de Lotes', 20, 20);
    state.lotes.forEach((lote, i) => {
        doc.text(`${lote.id}: ${lote.variedad} - ${lote.area}ha`, 20, 30 + (i * 10));
    });
    doc.save('reporte.pdf');
}

function generarExcel() {
    const ws = XLSX.utils.json_to_sheet(state.lotes);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Lotes");
    XLSX.writeFile(wb, "lotes.xlsx");
}

// Actualización de UI
function actualizarUI() {
    // Actualizar tablas
    actualizarTabla('tablaLotes', state.lotes, ['id', 'variedad', 'area', 'densidad', 'plantas']);
    actualizarTabla('tablaInsumos', Object.entries(state.insumos).map(([k,v]) => 
        ({insumo: k, ...v})), ['insumo', 'cantidad', 'precio']);
    
    // Actualizar selectores
    const selectLote = document.getElementById('selectLote');
    selectLote.innerHTML = state.lotes.map(l => 
        `<option value="${l.id}">Lote ${l.id}</option>`);
}

function actualizarTabla(id, datos, campos) {
    const tabla = document.getElementById(id);
    tabla.innerHTML = `
        <thead><tr>${campos.map(c => `<th>${c}</th>`).join('')}</tr></thead>
        <tbody>
            ${datos.map(d => `
                <tr>${campos.map(c => `<td>${d[c]}</td>`).join('')}</tr>
            `).join('')}
        </tbody>
    `;
}

// Gráficos
let chartInstance;
function actualizarGraficos() {
    if(chartInstance) chartInstance.destroy();
    
    const ctx = document.getElementById('chartProduccion').getContext('2d');
    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: state.lotes.map(l => l.id),
            datasets: [{
                label: 'Producción por Lote',
                data: state.lotes.map(l => l.cosechas.reduce((a,b) => a + b.cantidad, 0)),
                backgroundColor: '#2c5f2d'
            }]
        }
    });
}

// Inicialización
document.addEventListener('DOMContentLoaded', actualizarUI);
</script>
</body>
</html>
