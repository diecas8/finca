<!-- Agrega esta sección en las tablas de registros -->
<div class="form-container">
    <h3>📋 Inventario de Insumos</h3>
    <table>
        <thead>
            <tr>
                <th>Insumo</th>
                <th>Unidad</th>
                <th>Total Comprado</th>
                <th>Disponible</th>
                <th>Última Actualización</th>
            </tr>
        </thead>
        <tbody id="inventarioInsumos"></tbody>
    </table>
</div>

<script>
    // Modificamos la estructura de insumos para incluir registro de movimientos
    let insumos = []; // Estructura actualizada:
    /*
    {
        id: Date.now(),
        fecha: "2024-05-20",
        tipo: "Urea",
        unidad: "Bulto",
        cantidad: 100,      // Total comprado
        disponible: 100,    // Stock actual
        valor: 50000,
        total: 5000000,
        movimientos: []     // Registro de compras y usos
    }
    */

    // Función modificada para guardar insumos (compra)
    function guardarInsumo() {
        const insumo = {
            id: Date.now(),
            fecha: document.getElementById('fechaCompra').value,
            tipo: document.getElementById('tipoInsumo').value,
            unidad: document.getElementById('unidadMedida').value,
            cantidad: parseFloat(document.getElementById('cantidadInsumo').value),
            disponible: parseFloat(document.getElementById('cantidadInsumo').value),
            valor: parseFloat(document.getElementById('valorUnitario').value),
            total: parseFloat(document.getElementById('totalInsumo').textContent.replace(/,/g, '')),
            movimientos: [{
                tipo: 'compra',
                fecha: new Date().toISOString().split('T')[0],
                cantidad: parseFloat(document.getElementById('cantidadInsumo').value),
                lote: null
            }]
        };

        if (editandoInsumo) {
            // Actualizar inventario al editar
            const original = insumos[indiceEdicionInsumo];
            const diferencia = insumo.cantidad - original.cantidad;
            insumo.disponible = original.disponible + diferencia;
            
            insumos[indiceEdicionInsumo] = insumo;
            editandoInsumo = false;
        } else {
            insumos.push(insumo);
        }

        actualizarInventario();
        actualizarSelectInsumos();
        document.getElementById('insumosForm').reset();
    }

    // Función para registrar uso de insumos (modificada)
    function registrarUsoInsumo() {
        const loteNumero = parseInt(document.getElementById('loteUsoInsumo').value);
        const insumoIndex = parseInt(document.getElementById('insumoDisponible').value);
        const cantidad = parseFloat(document.getElementById('cantidadUso').value);
        const fecha = document.getElementById('fechaUso').value;

        const insumo = insumos[insumoIndex];
        
        // Validación de stock
        if (cantidad > insumo.disponible) {
            alert(`Stock insuficiente! Disponible: ${insumo.disponible} ${insumo.unidad}`);
            return;
        }

        // Actualizar inventario
        insumo.disponible -= cantidad;
        insumo.movimientos.push({
            tipo: 'uso',
            fecha: fecha,
            cantidad: -cantidad,
            lote: loteNumero
        });

        // Registrar uso en el lote
        const lote = lotes.find(l => l.numero === loteNumero);
        if (!lote.insumosUsados) lote.insumosUsados = [];
        lote.insumosUsados.push({
            insumo: insumo.tipo,
            cantidad: cantidad,
            unidad: insumo.unidad,
            fecha: fecha
        });

        actualizarInventario();
        actualizarTablaUsoInsumos();
        document.getElementById('usoInsumosForm').reset();
    }

    // Función para actualizar el inventario
    function actualizarInventario() {
        const tbody = document.getElementById('inventarioInsumos');
        tbody.innerHTML = insumos.map(insumo => `
            <tr>
                <td>${insumo.tipo}</td>
                <td>${insumo.unidad}</td>
                <td>${insumo.cantidad}</td>
                <td class="${insumo.disponible < 10 ? 'stock-bajo' : ''}">${insumo.disponible}</td>
                <td>${new Date().toLocaleDateString()}</td>
            </tr>
        `).join('');
        
        // Actualizar también la tabla de insumos
        const tbodyInsumos = document.getElementById('registrosInsumos');
        tbodyInsumos.innerHTML = insumos.map((insumo, index) => `
            <tr>
                <td>${insumo.fecha}</td>
                <td>${insumo.tipo}</td>
                <td>${insumo.unidad}</td>
                <td>${insumo.cantidad}</td>
                <td>${insumo.disponible}</td>
                <td>$${insumo.valor.toLocaleString()}</td>
                <td>$${insumo.total.toLocaleString()}</td>
                <td>
                    <button onclick="editarInsumo(${index})">Editar</button>
                    <button onclick="eliminarInsumo(${index})">Eliminar</button>
                </td>
            </tr>
        `).join('');
    }

    // Función modificada para eliminar insumos
    function eliminarInsumo(index) {
        const insumo = insumos[index];
        if (insumo.disponible !== insumo.cantidad) {
            alert('No puedes eliminar un insumo con movimientos registrados!');
            return;
        }
        insumos.splice(index, 1);
        actualizarInventario();
    }

    // Agregar este estilo para stock bajo
    <style>
        .stock-bajo {
            color: #ff4444;
            font-weight: bold;
            background-color: #ffe6e6;
        }
    </style>
</script>
